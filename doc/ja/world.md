# ワールドモジュールガイド

`multi_pinhole.world` モジュールはボクセル、カメラ、そして必要に応じて遮蔽物をまとめ、シミュレートされたシーンを構成します。コンポーネント間の参照を維持するだけでなく、可視性の把握、疎な投影行列の構築、シナリオの永続化、セットアップの可視化を行うためのユーティリティも提供します。

## ヘルパーユーティリティ
配列の管理を円滑にする 2 つの内部ヘルパーがあります。

* `type_list` は単一オブジェクトまたはリストを受け取り、要素型を強制しながらリストに変換します。複数のセッターを支えており、呼び出し側が単体または複数のインスタンスを渡せるようにします。
* `_blocks_lengths` と `_slice_blocks` は点群および疎行列ブロックのコレクションを扱い、後続の投影処理のために軽量なスライシング機能を提供します。

## ワールドの構築
`World.__init__` はオプションのボクセル、カメラ、壁、`inside_func` 引数を受け取ります。入力が省略された場合は既定値にフォールバックし、共有状態を要求できるよう直ちにワールドへ再接続されます。カメラはインデックスマッピング（`{int: Camera}`）に正規化され、カメラごとの可視フラグ、各眼の投影行列、カメラ単位の投影オペレーターをキャッシュする並行ディクショナリを構築します。`inside_func` を与えると、内部頂点マスクが即座に初期化されます。指定しない場合は「すべての頂点が内部」という遅延初期化のままです。

壁は `stl.mesh.Mesh` オブジェクトのリストに正規化されます。変更があるとキャッシュを無効化し、`update_min` と `update_max` を通じて事前計算済みのメッシュ境界を更新し、後のプロットに備えて結合した軸方向の限界値を保存します。

## シーンの内省と永続化
`camera_info` と `voxel_info` は登録済みのセンサーおよびグリッドの概要を提供します。`save_world`/`load_world` は `dill` を用いてシーン全体をシリアライズし、長時間のシミュレーションを容易にチェックポイントできます。カメラ、ボクセル、壁のプロパティセッターは可能な限りキャッシュ済みの可視性・投影データを再利用し、それが不可能な場合は古い行列を無効化して依存計算の一貫性を保ちます。

## 可視性の評価
`set_inside_vertices` はボクセルグリッド上で評価される呼び出し可能オブジェクトを受け取り、アクティブなボリュームを定義できます。`_find_visible_points` は点をカメラ座標に変換し、各眼・開口部・壁に対して判定を行い、ブールマスクを返します。`_find_visible_vertices` はそのルーチンをすべてのカメラ（または指定されたカメラ）に繰り返し適用し、眼ごと・頂点ごとの結果をキャッシュします。`find_visible_voxels` は頂点の可視性をボクセル単位に集約し、各眼について「不可視」「部分的に可視」「完全に可視」を示すフラグを生成します。

## 投影の組み立て
`set_projection_matrix` は高コストな投影パイプラインを調整します。各カメラの眼について、`_calc_voxel_image_for_eye` がサブボクセル補間器を準備し、可視性を評価し、疎なオペレーターを乗算してボクセルからサブピクセルへの行列を構築します。作業は推定疎度に基づいて自動的に分割され、`ThreadPoolExecutor` を使って並列実行する（あるいはジョブが 1 つだけなら直列実行する）ことが可能です。眼ごとの結果は `_projection` に蓄積され、画面変換を適用した後の統合されたスクリーンスペース行列は `_P_matrix` に保存されます。

## 可視化
`draw_camera_orientation` はボクセル境界、カメラ姿勢、登録された壁を重ね合わせた便利な 3D プロットを提供します。軸の範囲はデフォルトでボクセルと壁の範囲（わずかに拡張）を結合したものになりますが、キーワード引数で上書きできます。
